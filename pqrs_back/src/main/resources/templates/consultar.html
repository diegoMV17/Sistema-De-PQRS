<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema PQRS - Consulta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Navbar -->
    <nav
      class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 sticky top-0 z-50"
    >
      <div th:replace="~{fragments/navbar :: navbar}"></div>
    </nav>

    <!-- Contenido principal -->
    <main class="px-4 py-10 min-h-[70vh]">
      <div class="max-w-3xl mx-auto text-center mb-10">
        <h1 class="text-3xl font-bold">Consulta el estado de tu PQRS</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
          Ingrese su <strong>número de radicado</strong> o su
          <strong>cédula</strong> para consultar.
        </p>
      </div>

      <!-- Formulario -->
      <div
        class="max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6"
      >
        <form id="consultaForm" class="flex flex-col gap-4">
          <div>
            <label for="numeroRadicado" class="block text-sm font-medium"
              >Número de radicado</label
            >
            <input
              type="text"
              id="numeroRadicado"
              placeholder="Ej: 2025-000123"
              class="w-full border border-blue-300 rounded-md px-4 py-3 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
            />
          </div>

          <div>
            <label for="cedula" class="block text-sm font-medium">Cédula</label>
            <input
              type="text"
              id="cedula"
              placeholder="Ej: 1234567890"
              class="w-full border border-blue-300 rounded-md px-4 py-3 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-600"
            />
          </div>

          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-600"
          >
            Consultar
          </button>
        </form>
      </div>
    </main>

    <!-- Modal -->
    <div
      id="resultadoModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div
        class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl w-full max-w-2xl p-6 relative animate-fadeIn max-h-[90vh] flex flex-col"
      >
        <!-- Botón cerrar -->
        <button
          id="cerrarModal"
          class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-2xl font-bold transition"
        >
          &times;
        </button>

        <!-- Header -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">
          <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">
            Resultado de la Consulta
          </h2>
        </div>

        <!-- Contenido dinámico -->
        <div
          id="contenidoModal"
          class="flex-1 space-y-4 text-gray-700 dark:text-gray-200"
        >
          <!-- Aquí se insertará el contenido de la consulta -->
        </div>
        <!-- Botón para descargar PDF -->
        <div class="mt-4 flex justify-end border-t border-gray-200 dark:border-gray-700 pt-3">
          <button
            id="descargarPDF"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-blue-600"
          >
            Descargar PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Animación con Tailwind -->
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.25s ease-out;
      }
    </style>

    <!-- Animación suave -->
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.25s ease-out;
      }
    </style>

    <!-- Animación con Tailwind -->
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fadeIn {
        animation: fadeIn 0.25s ease-out;
      }
    </style>

    <!-- Footer -->
    <footer class="mt-10">
      <div th:replace="~{fragments/footer :: footer}"></div>
    </footer>

    <!-- Scripts -->
    <script src="navbar.js"></script>
    <script src="footer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      document
        .getElementById("consultaForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const numeroRadicado = document
            .getElementById("numeroRadicado")
            .value.trim();
          const cedula = document.getElementById("cedula").value.trim();

          if (!numeroRadicado && !cedula) {
            alert("Debe ingresar al menos el número de radicado o la cédula.");
            return;
          }

          let url = "";
          if (numeroRadicado) {
            url = `/api/pqrs/buscarPorRadicado/${numeroRadicado}`;
          } else if (cedula) {
            url = `/api/pqrs/buscarPorDocumento/${cedula}`;
          }

          try {
            const response = await fetch(url);

            // Verificar si no hay resultados (204) o error
            if (!response.ok || response.status === 204) {
              if (numeroRadicado) {
                alert("El número de radicado ingresado no existe.");
              } else if (cedula) {
                alert("La cédula ingresada no está registrada.");
              }
              return;
            }

            const data = await response.json();

            if (!data.length) {
              // En caso de que el backend devuelva [] en lugar de 204
              if (numeroRadicado) {
                alert("El número de radicado ingresado no existe.");
              } else if (cedula) {
                alert("La cédula ingresada no está registrada.");
              }
              return;
            }

            // Mostrar resultados en el modal
            const contenido = data
              .map(
                (pqrs) => `
<div class="border-b border-gray-200 dark:border-gray-700 pb-2 mb-2">
  <p><strong>Cédula:</strong> ${
    pqrs.peticionario?.numeroDocumento || "N/A"
  }</p>
  <p><strong>Número de radicado:</strong> ${pqrs.numeroRadicado}</p>
  <p class="descripcion-modal"><strong>Descripción:</strong> ${pqrs.descripcion}</p>
  <p><strong>Estado:</strong> ${pqrs.estado?.nombre || "Sin estado"}</p>
</div>
`
              )
              .join("");

            document.getElementById("contenidoModal").innerHTML = contenido;
            document
              .getElementById("resultadoModal")
              .classList.remove("hidden");
            document.getElementById("resultadoModal").classList.add("flex");
          } catch (err) {
            console.error("Error consultando:", err);
            alert("Ocurrió un error al consultar la información.");
          }
        });

      // Cerrar modal
      document.getElementById("cerrarModal").addEventListener("click", () => {
        document.getElementById("resultadoModal").classList.add("hidden");
        document.getElementById("resultadoModal").classList.remove("flex");
      });

     document.getElementById("descargarPDF").addEventListener("click", function () {
  const doc = new window.jspdf.jsPDF();

  // Fondo del documento
  doc.setFillColor(240, 245, 255);
  doc.rect(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), 'F');

  // Encabezado
  doc.setFillColor(220, 230, 250);
  doc.roundedRect(10, 10, doc.internal.pageSize.getWidth() - 20, 22, 5, 5, 'F');
  doc.setFontSize(18);
  doc.setTextColor(40, 40, 80);
  doc.text("Consulta PQRS", doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });

  // Fecha
  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  const fecha = new Date();
  const fechaStr = fecha.toLocaleDateString() + " " + fecha.toLocaleTimeString();
  doc.text("Fecha de descarga: " + fechaStr, doc.internal.pageSize.getWidth() / 2, 30, { align: "center" });

  // Línea divisoria
  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.5);
  doc.line(15, 36, doc.internal.pageSize.getWidth() - 15, 36);

  // Contenido de registros
  const contenidoDiv = document.getElementById("contenidoModal");
  const registros = contenidoDiv.querySelectorAll(".border-b");

  let y = 44;
  const pageHeight = doc.internal.pageSize.getHeight();

  registros.forEach((reg) => {
    reg.querySelectorAll("p").forEach(p => {
      let label = "";
      let valor = "";
      if (p.querySelector("strong")) {
        label = p.querySelector("strong").innerText.trim();
        valor = p.innerText.replace(label, "").trim();
      } else {
        valor = p.innerText.trim();
      }
      const marginSides = 28;
      const maxTextWidth = doc.internal.pageSize.getWidth() - marginSides * 2 - 10;
      let lines = [];
      let boxHeight = 18 + 9; // Altura mínima para una línea
      if (label === "Descripción:") {
        lines = doc.splitTextToSize(valor, maxTextWidth - 10);
        boxHeight = 18 + lines.length * 9;
        // Si la caja de descripción no cabe, salto de página antes de dibujarla
        if (y + boxHeight > doc.internal.pageSize.getHeight() - 40) {
          doc.addPage();
          y = 44;
        }
      } else if (["Cédula:", "Número de radicado:", "Estado:"].includes(label)) {
        boxHeight = 18 + 9;
        // Si la caja no cabe, salto de página antes de dibujarla
        if (y + boxHeight > doc.internal.pageSize.getHeight() - 40) {
          doc.addPage();
          y = 44;
        }
      }
      if (["Cédula:", "Número de radicado:", "Estado:"].includes(label)) {
        // Mostrar valor al lado del label, alineado sin tanto espacio
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(80, 140, 220);
        doc.roundedRect(marginSides, y, maxTextWidth + 10, boxHeight, 7, 7, 'FD');
        doc.setFontSize(13);
        doc.setTextColor(30, 60, 160);
        doc.text(label, marginSides + 12, y + 14);
        doc.setFontSize(12);
        doc.setTextColor(60, 60, 60);
        const labelWidth = doc.getTextWidth(label);
        doc.text(valor, marginSides + 12 + labelWidth + 8, y + 14);
        y += boxHeight + 12; // Espacio extra entre cajas
      } else {
        if (label === "Descripción:") {
          lines = doc.splitTextToSize(valor, maxTextWidth - 10);
        } else {
          lines = doc.splitTextToSize(valor, maxTextWidth);
        }
        boxHeight = 18 + lines.length * 9;
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(80, 140, 220);
        doc.roundedRect(marginSides, y, maxTextWidth + 10, boxHeight, 7, 7, 'FD');
        doc.setFontSize(13);
        doc.setTextColor(30, 60, 160);
        doc.text(label, marginSides + 12, y + 14);
        doc.setFontSize(12);
        doc.setTextColor(60, 60, 60);
        let yLine = y + 26;
        lines.forEach(line => {
          doc.text(line, marginSides + 12, yLine);
          yLine += 9;
        });
        y += boxHeight + 12;
      }
      // Salto de página si se pasa del límite
      if (y > doc.internal.pageSize.getHeight() - 40) {
        doc.addPage();
        y = 44;
      }
    });
  });

  doc.save("consulta_pqrs.pdf");
});

    </script>
    <style>
      .descripcion-modal {
        word-break: break-word;
        max-width: 100%;
        overflow-wrap: anywhere;
        white-space: pre-line;
      }
    </style>
  </body>
</html>
